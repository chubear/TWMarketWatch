<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>市場觀測指標</title>
<style>
body { 
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC", "Microsoft JhengHei", sans-serif; 
    margin: 16px; 
}

.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
    border-bottom: 2px solid #ddd;
}

.tab-button {
    padding: 10px 20px;
    background: #f4f6f8;
    border: none;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background 0.2s;
}

.tab-button:hover {
    background: #e8ebed;
}

.tab-button.active {
    background: #fff;
    border-bottom: 2px solid #fff;
    margin-bottom: -2px;
    font-weight: 600;
    color: #0066cc;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.controls { 
    margin-bottom: 12px; 
    display:flex; 
    gap:8px; 
    align-items:center; 
    flex-wrap:wrap; 
}

.report-table { 
    border-collapse: collapse; 
    width:100%; 
    table-layout: fixed; 
    word-wrap: break-word; 
    font-size:0.95rem; 
}
.report-table th, .report-table td { 
    border:1px solid #ddd; 
    padding:6px 8px; 
    vertical-align:middle; 
    text-align:center; 
}
.report-table thead th { 
    background:#f4f6f8; 
    font-weight:600; 
    position: sticky; 
    top:0; 
    z-index:2; 
    backdrop-filter: blur(2px); 
}
.report-table tbody tr:nth-child(even) { 
    background:#fafafa; 
}
.report-table th:nth-child(2),
.report-table td:nth-child(2) {
    width: 15%; /* 指標名稱欄位較大 */
}

.report-table th:nth-child(3),
.report-table td:nth-child(3) {
    width: 5%; /* 單位欄位較小 */
}

@media (max-width:640px) { 
    .controls { 
        flex-direction:column; 
        align-items:stretch; 
    } 
    .report-table { 
        font-size:0.85rem; 
    } 
    .tab-button {
        padding: 8px 16px;
        font-size: 0.9rem;
    }
}
</style>
</head>
<body>

<div class="tabs">
    <button class="tab-button active" data-tab="tw">台股市場</button>
    <button class="tab-button" data-tab="overseas">海外市場</button>
</div>

<div id="tw-tab" class="tab-content active">
    <div class="controls">
        <button class="reload-btn" data-market="tw">重新載入資料</button>
        <button class="download-csv-btn" data-market="tw">下載 CSV</button>
    </div>
    <table class="report-table" data-market="tw" aria-live="polite">
        <thead></thead>
        <tbody><tr><td colspan="20">等待資料讀取中...</td></tr></tbody>
    </table>
</div>

<div id="overseas-tab" class="tab-content">
    <div class="controls">
        <button class="reload-btn" data-market="overseas">重新載入資料</button>
        <button class="download-csv-btn" data-market="overseas">下載 CSV</button>
    </div>
    <table class="report-table" data-market="overseas" aria-live="polite">
        <thead></thead>
        <tbody><tr><td colspan="20">等待資料讀取中...</td></tr></tbody>
    </table>
</div>

<script>
const API_URLS = {
    tw: 'https://api1.dottdot.com/api/reports/tw_market_watch',
    overseas: 'https://api1.dottdot.com/api/reports/overseas_market_watch'
};

/* 從 API JSON 轉換成表格資料結構 */
function jsonToRows(jsonData) {
    if (!jsonData || !Array.isArray(jsonData) || jsonData.length === 0) {
        return [];
    }
    
    // 取得所有欄位名稱（從第一筆資料）
    const firstItem = jsonData[0];
    const headers = Object.keys(firstItem);
    
    // 建立表頭
    const rows = [headers];
    
    // 建立資料列
    jsonData.forEach(item => {
        const row = headers.map(header => {
            const value = item[header];
            return value !== null && value !== undefined ? String(value) : '';
        });
        rows.push(row);
    });
    
    return rows;
}

function buildTable(table, rows) {
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    thead.innerHTML = '';
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="20">無資料。</td></tr>';
        return;
    }

    const header = rows[0];
    const trh = document.createElement('tr');
    header.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h || '';
        trh.appendChild(th);
    });
    thead.appendChild(trh);

    for (let r = 1; r < rows.length; r++) {
        const row = rows[r];
        if (row.every(c => c === undefined || c === '')) continue;
        const tr = document.createElement('tr');
        row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
    
    if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="' + Math.max(header.length, 1) + '">無資料列</td></tr>';
    }
}

async function loadFromAPI(market) {
    const url = API_URLS[market];
    const table = document.querySelector(`.report-table[data-market="${market}"]`);
    
    try {
        const res = await fetch(url, {
            cache: "no-store",
            headers: {
                'Accept': 'application/json'
            }
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        
        // 檢查 API 回應格式
        if (json.status === 'success' && Array.isArray(json.data)) {
            const rows = jsonToRows(json.data);
            buildTable(table, rows);
        } else {
            throw new Error('API 回應格式不正確');
        }
    } catch (err) {
        console.error(err);
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '<tr><td colspan="20">載入失敗：' + err.message + '</td></tr>';
    }
}

async function downloadCSV(market) {
    const url = API_URLS[market];
    
    try {
        const res = await fetch(url, {
            cache: "no-store",
            headers: {
                'Accept': 'application/json'
            }
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();

        if (json.status === 'success' && Array.isArray(json.data)) {
            const rows = jsonToRows(json.data);
            const csvContent = rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const downloadUrl = URL.createObjectURL(blob);
            link.setAttribute('href', downloadUrl);
            link.setAttribute('download', `${market}_market_report.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            throw new Error('API 回應格式不正確');
        }
    } catch (err) {
        console.error('下載失敗：' + err.message);
        alert('下載失敗：' + err.message);
    }
}

// 分頁切換
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
        const targetTab = button.getAttribute('data-tab');
        
        // 更新分頁按鈕樣式
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // 顯示對應的分頁內容
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${targetTab}-tab`).classList.add('active');
    });
});

// 重新載入按鈕
document.querySelectorAll('.reload-btn').forEach(button => {
    button.addEventListener('click', () => {
        const market = button.getAttribute('data-market');
        loadFromAPI(market);
    });
});

// 下載 CSV 按鈕
document.querySelectorAll('.download-csv-btn').forEach(button => {
    button.addEventListener('click', () => {
        const market = button.getAttribute('data-market');
        downloadCSV(market);
    });
});

/* 頁面載入時自動載入台股資料 */
window.addEventListener('load', () => {
    loadFromAPI('tw');
});
</script>

</body>
</html>